{"version":3,"sources":["../../../src/mesh/webgl/MeshRenderer.js"],"names":["core","MeshRenderer","renderer","shader","onContextChange","gl","Shader","render","mesh","texture","_texture","valid","glData","_glDatas","CONTEXT_UID","bindVao","vertexBuffer","glCore","GLBuffer","createVertexBuffer","vertices","STREAM_DRAW","uvBuffer","uvs","indexBuffer","createIndexBuffer","indices","STATIC_DRAW","vao","dirty","indexDirty","VertexArrayObject","addIndex","addAttribute","attributes","aVertexPosition","FLOAT","aTextureCoord","upload","bindShader","uniforms","uSampler","bindTexture","state","setBlendMode","blendMode","translationMatrix","worldTransform","toArray","alpha","worldAlpha","tint","tintRgb","drawMode","Mesh","DRAW_MODES","TRIANGLE_MESH","TRIANGLE_STRIP","TRIANGLES","draw","length","ObjectRenderer","WebGLRenderer","registerPlugin"],"mappings":"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","file":"MeshRenderer.js","sourcesContent":["import * as core from '../../core';\nimport glCore from 'pixi-gl-core';\nimport { default as Mesh } from '../Mesh';\nimport { readFileSync } from 'fs';\nimport { join } from 'path';\n\n/**\n * WebGL renderer plugin for tiling sprites\n *\n * @class\n * @memberof PIXI\n * @extends PIXI.ObjectRenderer\n */\nexport default class MeshRenderer extends core.ObjectRenderer\n{\n\n    /**\n     * constructor for renderer\n     *\n     * @param {WebGLRenderer} renderer The renderer this tiling awesomeness works for.\n     */\n    constructor(renderer)\n    {\n        super(renderer);\n\n        this.shader = null;\n    }\n\n    /**\n     * Sets up the renderer context and necessary buffers.\n     *\n     * @private\n     */\n    onContextChange()\n    {\n        const gl = this.renderer.gl;\n\n        this.shader = new core.Shader(gl,\n            readFileSync(join(__dirname, './mesh.vert'), 'utf8'),\n            readFileSync(join(__dirname, './mesh.frag'), 'utf8'));\n    }\n\n    /**\n     * renders mesh\n     *\n     * @param {PIXI.mesh.Mesh} mesh mesh instance\n     */\n    render(mesh)\n    {\n        const renderer = this.renderer;\n        const gl = renderer.gl;\n        const texture = mesh._texture;\n\n        if (!texture.valid)\n        {\n            return;\n        }\n\n        let glData = mesh._glDatas[renderer.CONTEXT_UID];\n\n        if (!glData)\n        {\n            renderer.bindVao(null);\n\n            glData = {\n                shader: this.shader,\n                vertexBuffer: glCore.GLBuffer.createVertexBuffer(gl, mesh.vertices, gl.STREAM_DRAW),\n                uvBuffer: glCore.GLBuffer.createVertexBuffer(gl, mesh.uvs, gl.STREAM_DRAW),\n                indexBuffer: glCore.GLBuffer.createIndexBuffer(gl, mesh.indices, gl.STATIC_DRAW),\n                // build the vao object that will render..\n                vao: null,\n                dirty: mesh.dirty,\n                indexDirty: mesh.indexDirty,\n            };\n\n            // build the vao object that will render..\n            glData.vao = new glCore.VertexArrayObject(gl)\n                .addIndex(glData.indexBuffer)\n                .addAttribute(glData.vertexBuffer, glData.shader.attributes.aVertexPosition, gl.FLOAT, false, 2 * 4, 0)\n                .addAttribute(glData.uvBuffer, glData.shader.attributes.aTextureCoord, gl.FLOAT, false, 2 * 4, 0);\n\n            mesh._glDatas[renderer.CONTEXT_UID] = glData;\n        }\n\n        renderer.bindVao(glData.vao);\n\n        if (mesh.dirty !== glData.dirty)\n        {\n            glData.dirty = mesh.dirty;\n            glData.uvBuffer.upload(mesh.uvs);\n        }\n\n        if (mesh.indexDirty !== glData.indexDirty)\n        {\n            glData.indexDirty = mesh.indexDirty;\n            glData.indexBuffer.upload(mesh.indices);\n        }\n\n        glData.vertexBuffer.upload(mesh.vertices);\n\n        renderer.bindShader(glData.shader);\n\n        glData.shader.uniforms.uSampler = renderer.bindTexture(texture);\n\n        renderer.state.setBlendMode(mesh.blendMode);\n\n        glData.shader.uniforms.translationMatrix = mesh.worldTransform.toArray(true);\n        glData.shader.uniforms.alpha = mesh.worldAlpha;\n        glData.shader.uniforms.tint = mesh.tintRgb;\n\n        const drawMode = mesh.drawMode === Mesh.DRAW_MODES.TRIANGLE_MESH ? gl.TRIANGLE_STRIP : gl.TRIANGLES;\n\n        glData.vao.draw(drawMode, mesh.indices.length, 0);\n    }\n}\n\ncore.WebGLRenderer.registerPlugin('mesh', MeshRenderer);\n"]}